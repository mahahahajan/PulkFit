name: Fitbit Daily Data Fetch

on:
  schedule:
    - cron: '0 12 * * *'  # runs daily at 12:00 UTC
  workflow_dispatch:

jobs:
  fetch_fitbit_data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Ensure temp_downloads exists
        run: mkdir -p temp_downloads

      # -------------------
      # Restore previous token (if exists)
      # -------------------
      - name: Restore previous Fitbit token
        uses: actions/download-artifact@v3
        with:
          name: fitbit-user-details
          path: temp_downloads
        continue-on-error: true  # first run won't have artifact

      # -------------------
      # Save initial Fitbit user details (from secret if first run)
      # -------------------
      - name: Save initial Fitbit user details
        run: |
          if [ ! -f temp_downloads/user_details.json ]; then
            echo "${FITBIT_USER_DETAILS}" > temp_downloads/user_details.json
            echo "Saved initial Fitbit user details"
          else
            echo "User details already exist, skipping initial save"
          fi

      # -------------------
      # Run daily script
      # -------------------
      - name: Run Daily Script
        run: python run_daily.py

      # -------------------
      # Persist refreshed token
      # -------------------
      - name: Save refreshed Fitbit token
        uses: actions/upload-artifact@v3
        with:
          name: fitbit-user-details
          path: temp_downloads/user_details.json
