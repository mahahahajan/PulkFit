name: Fitbit Daily Data Fetch

on:
  schedule:
    - cron: '0 12 * * *'  # runs daily at 12:00 UTC
  workflow_dispatch:

jobs:
  fetch_fitbit_data:
    runs-on: ubuntu-latest
    steps:
      # -------------------
      # 1. Checkout code
      # -------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # -------------------
      # 2. Ensure temp_downloads exists
      # -------------------
      - name: Ensure temp_downloads exists
        run: mkdir -p temp_downloads

      # -------------------
      # 3. Restore previous Fitbit token (if exists)
      # -------------------
      - name: Restore previous Fitbit token
        uses: actions/download-artifact@v4
        with:
          name: fitbit-user-details
          path: temp_downloads
        continue-on-error: true  # first run won't have an artifact

      # -------------------
      # 4. Save initial Fitbit user details from secret if first run
      # -------------------
      - name: Save initial Fitbit user details
        run: |
          if [ ! -f temp_downloads/user_details.json ]; then
            echo "${FITBIT_USER_DETAILS}" > temp_downloads/user_details.json
            echo "Saved initial Fitbit user details"
          else
            echo "User details already exist, skipping initial save"
          fi

      # -------------------
      # 5. Run daily script
      # -------------------
      - name: Run Daily Script
        run: python run_daily.py

      # -------------------
      # 6. Persist refreshed Fitbit token
      # -------------------
      - name: Save refreshed Fitbit token
        uses: actions/upload-artifact@v4
        with:
          name: fitbit-user-details
          path: temp_downloads/user_details.json
          overwrite: true
          retention-days: 30
