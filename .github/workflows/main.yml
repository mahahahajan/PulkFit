name: Fitbit Daily Data Fetch

on:
  schedule:
    - cron: '0 12 * * *'  # runs daily at 12:00 UTC
  workflow_dispatch:

jobs:
  fetch_fitbit_data:
    runs-on: ubuntu-latest
    steps:
      # -------------------
      # 1. Checkout code
      # -------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Ensure temp_downloads exists
        run: mkdir -p temp_downloads

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Restore previous Fitbit token
        uses: actions/download-artifact@v4
        with:
          name: fitbit-user-details
          path: temp_downloads
        continue-on-error: true

      - name: Save initial Fitbit user details
        run: |
          if [ ! -f temp_downloads/user_details.json ]; then
            echo "$FITBIT_USER_DETAILS" | base64 -d > temp_downloads/user_details.json
            echo "Decoded B64 user details into file"
          else
            echo "File exists, skipping"
          fi
        env:
            GMAIL_CREDENTIALS: ${{ secrets.GMAIL_CREDENTIALS }}
            GMAIL_TOKEN: ${{ secrets.GMAIL_TOKEN }}
            NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
            HEVY_EMAIL: ${{ secrets.HEVY_EMAIL }}
            HEVY_PASSWORD: ${{ secrets.HEVY_PASSWORD }}
            GEMINI_AI_KEY: ${{ secrets.GEMINI_AI_KEY }}
            FITBIT_USER_DETAILS: ${{ secrets.FITBIT_USER_DETAILS }}
            FITBIT_CLIENT_DETAILS: ${{ secrets.FITBIT_CLIENT_DETAILS }}

      - name: Debug user_details.json
        run: |
          echo "Contents of temp_downloads/user_details.json:"
          cat temp_downloads/user_details.json

      - name: Run Daily Script
        run: python run_daily.py
        env:
            GMAIL_CREDENTIALS: ${{ secrets.GMAIL_CREDENTIALS }}
            GMAIL_TOKEN: ${{ secrets.GMAIL_TOKEN }}
            NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
            HEVY_EMAIL: ${{ secrets.HEVY_EMAIL }}
            HEVY_PASSWORD: ${{ secrets.HEVY_PASSWORD }}
            GEMINI_AI_KEY: ${{ secrets.GEMINI_AI_KEY }}
            FITBIT_USER_DETAILS: ${{ secrets.FITBIT_USER_DETAILS }}
            FITBIT_CLIENT_DETAILS: ${{ secrets.FITBIT_CLIENT_DETAILS }}

      - name: Save refreshed Fitbit token
        uses: actions/upload-artifact@v4
        with:
          name: fitbit-user-details
          path: temp_downloads
          overwrite: true
          retention-days: 30
